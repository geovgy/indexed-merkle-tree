# Indexed Merkle Tree

An implementation of [Indexed Merkle Tree](https://docs.aztec.network/aztec/concepts/advanced/storage/indexed_merkle_tree) in TypeScript and Noir. This is a modified fork of the [indexed-merkle-noir](https://github.com/numtel/indexed-merkle-noir) repo from numtel.

* Keys can be max 64-bit uints
* Values can be any field element

### Notable changes from indexed-merkle-noir

* No pre-determined max tree depth
* No pre-determined hash function
* Convert JavaScript implementation into TypeScript

## Installation

```
$ git clone https://github.com/geovgy/indexed-merkle-tree
$ cd indexed-merkle-tree
$ bun install

# Test typescript implementation
$ bun test

# Test noir implementation
$ nargo test
```

## TypeScript Usage

The `IndexedMerkleTree` class provides methods to create and manage an indexed Merkle tree.

```typescript
import {IndexedMerkleTree} from 'indexed-merkle-tree';
import {poseidon2, poseidon4} from "poseidon-lite";

function poseidonHash(inputs: bigint[]): bigint {
    if (inputs.length === 2) return poseidon2(inputs);
    return poseidon4(inputs);
}

// Create a new tree
const tree = new IndexedMerkleTree(poseidonHash);

// Insert an item (key must be bigint > 0, value must be bigint >= 0)
tree.insert(10n, 345n);
tree.insert(20n, 234n);
const transitionProof = tree.insert(30n, 123n);

// Generate proof for a key
const proof = tree.generateProof(20n);
// Returns { leafIdx, leaf, root, siblings }

// Generate exclusion proof (proves a key does NOT exist)
const exclusionProof = tree.generateExclusionProof(13n);
// Returns proof for neighboring key that proves 13n doesn't exist

// Verify a proof
const isValid = tree.verifyProof(proof);
const isValidInsert = tree.verifyInsertionProof(transitionProof);
// Returns true if proof is valid
```

### IndexedMerkleTree Methods

- **constructor(hasher)**: Creates a new Indexed Merkle Tree with given hash function
- **insert(key, value)**: Inserts a new item with the given key and value
  - `key`: bigint greater than 0
  - `value`: bigint greater than or equal to 0
  - Returns insertion proof data object
- **generateProof(key)**: Generates a Merkle proof for the given key
  - Returns `{leafIdx, leaf, root, siblings}`
- **generateExclusionProof(key)**: Generates a proof that a key doesn't exist in the tree
  - Returns proof for a neighboring key that proves the target key doesn't exist
- **verifyProof(proof)**: Verifies a Merkle proof
  - Returns `true` if valid, `false` otherwise
- **verifyInsertionProof(insertionProof)**: Verifies an insertion proof
  - Returns `true` if valid, `false` otherwise

## Noir Library Functions

The Noir library includes an `IndexedMerkleTree` struct with implementation functions for verifying proofs generated by the TypeScript implementation:

- **new**: Creates a new Indexed Merkle Tree with given hash functions
- **verify_proof**: Verifies that a leaf with the given properties exists in the Merkle tree.
- **verify_exclusion_proof**: Verifies that a key does NOT exist in the Merkle tree. It asserts the following:
    1. The proof is valid (calls `verify_proof`)
    2. The excluded key is greater than the leaf key
    3. The excluded key is less than the next key (if next key exists)
- **verify_insertion_proof**: Verifies that the tree root state transition is valid for the given insertion. It asserts the following:
    1. All three individual proofs must be valid
    2. Sibling arrays for both leaves are same length
    3. The "sub-roots" of both changed leaves match

## License

MIT
